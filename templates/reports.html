{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <h1 class="page-title">Отчеты ABLLS-R</h1>
    <p class="page-subtitle">Сводка освоения навыков и динамика по выбранному ребенку.</p>
  </section>

  <section class="card">
    <h2>Выбор ребенка</h2>
    {% if visible_children %}
      <form class="form form-inline" method="get" action="/reports">
        <label>
          Ребенок
          <select name="child_id" required>
            {% for child in visible_children %}
              <option value="{{ child.id }}" {% if child.id == selected_child_id %}selected{% endif %}>{{ child.full_name }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit">Открыть отчет</button>
      </form>
    {% else %}
      <p>Нет детей, доступных для просмотра.</p>
    {% endif %}
  </section>

  {% if selected_child %}
    <section class="panel-stack">
      <article class="card">
        <h2>Динамика по дням: Самостоятельно / С подсказкой</h2>
        {% if daily_points %}
          <div class="daily-chart-wrap">
            <canvas class="daily-line-chart" data-daily-chart='{{ daily_points | tojson }}' aria-label="Динамика по дням"></canvas>
          </div>
          <div class="daily-chart-legend">
            <span><i class="dot dot-independent"></i> Самостоятельно</span>
            <span><i class="dot dot-prompted"></i> С подсказкой</span>
          </div>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Самостоятельно</th>
                  <th>С подсказкой</th>
                </tr>
              </thead>
              <tbody>
                {% for point in daily_points %}
                  <tr>
                    <td>{{ point.date }}</td>
                    <td>{{ point.independent }}</td>
                    <td>{{ point.prompted }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>Недостаточно данных для построения графика по дням.</p>
        {% endif %}
      </article>

      <section class="grid">
      <article class="card">
        <h2>Сводка по разделам: {{ selected_child.full_name }}</h2>
        {% if section_rows %}
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Раздел</th>
                  <th>Освоено</th>
                  <th>Оценено</th>
                  <th>Всего навыков</th>
                  <th>Выполнение (%)</th>
                  <th>Средний балл (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for row in section_rows %}
                  <tr>
                    <td>{{ row.section_code }} - {{ row.section_name }}</td>
                    <td>{{ row.mastered }}</td>
                    <td>{{ row.scored }}</td>
                    <td>{{ row.total }}</td>
                    <td>{{ row.completion_pct }}</td>
                    <td>{{ row.score_pct }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>По выбранному ребенку пока нет оценок.</p>
        {% endif %}
      </article>

      <article class="card">
        <h2>Последние оценки</h2>
        {% if recent_assessments %}
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Код</th>
                  <th>Режим</th>
                  <th>Навык</th>
                  <th>Балл</th>
                </tr>
              </thead>
              <tbody>
                {% for row in recent_assessments %}
                  {% set task = task_by_code.get(row.area) %}
                  <tr>
                    <td>{{ row.assessment_date }}</td>
                    <td>{{ row.area }}</td>
                    <td>{{ "С подсказкой" if row.is_prompted else "Самостоятельно" }}</td>
                    <td>{{ task.objective if task else "-" }}</td>
                    <td>{{ row.score }}{% if task %} / {{ task.max_score }}{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>Оценок пока нет.</p>
        {% endif %}
      </article>
      </section>
    </section>
  {% endif %}
{% endblock %}
