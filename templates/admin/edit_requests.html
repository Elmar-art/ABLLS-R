{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <h1 class="page-title">Админ: согласование запросов</h1>
    <p class="page-subtitle">Проверка входящих запросов терапистов на изменение оценок.</p>
  </section>

  <section class="card">
    <h2>Входящие запросы</h2>
    {% if edit_requests %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Терапист</th>
              <th>Ребенок</th>
              <th>Код навыка</th>
              <th>Навык</th>
              <th>Причина</th>
              <th>Запрошенное изменение</th>
              <th>Статус</th>
              <th>Решение</th>
            </tr>
          </thead>
          <tbody>
            {% for req in edit_requests %}
              {% set task = edit_request_task_map.get(req.area) %}
              <tr>
                <td>{{ req.created_at.strftime("%Y-%m-%d") }}</td>
                <td>{{ edit_request_user_map.get(req.therapist_id).full_name if edit_request_user_map.get(req.therapist_id) else req.therapist_id }}</td>
                <td>{{ edit_request_child_map.get(req.child_id).full_name if edit_request_child_map.get(req.child_id) else req.child_id }}</td>
                <td>{{ req.area }}</td>
                <td>{{ task.objective if task else "-" }}</td>
                <td>{{ req.reason }}</td>
                <td>
                  {% if req.requested_score is not none %}
                    {{ req.requested_score }}{% if task %} / {{ task.max_score }}{% endif %},
                    {{ "с подсказкой" if req.requested_is_prompted else "самостоятельно" }}
                    {% if req.requested_assessment_date %}, {{ req.requested_assessment_date }}{% endif %}
                    {% if req.requested_comment %}<br>{{ req.requested_comment }}{% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ req.status }}</td>
                <td>
                  {% if req.status == "pending" %}
                    <form class="form" method="post" action="/admin/edit-requests/{{ req.id }}/decision">
                      <select name="decision" required>
                        <option value="approved">Одобрить</option>
                        <option value="rejected">Отклонить</option>
                      </select>
                      <input type="text" name="admin_comment" placeholder="Комментарий">
                      <button type="submit">Сохранить</button>
                    </form>
                  {% else %}
                    <span class="hint">
                      Обработан
                      {% if req.applied_assessment_id %}<br>ID оценки: {{ req.applied_assessment_id }}{% endif %}
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>Новых запросов нет.</p>
    {% endif %}
  </section>
{% endblock %}
