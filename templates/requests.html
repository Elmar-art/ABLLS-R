{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <h1 class="page-title">Мои запросы на редактирование</h1>
    <p class="page-subtitle">Создание и отслеживание заявок на пересмотр оценок по навыкам ABLLS-R.</p>
  </section>

  <section class="card">
    <h2>Фильтр навыков</h2>
    <form class="form form-inline" method="get" action="/requests">
      <label>
        Раздел ABLLS-R
        <select name="section" required>
          {% for section in sections %}
            <option value="{{ section.code }}" {% if section.code == selected_section %}selected{% endif %}>{{ section.code }} - {{ section.name }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Показать навыки</button>
    </form>
  </section>

  <section class="grid">
    <article class="card">
      <h2>Создать запрос</h2>
      <form class="form" method="post" action="/requests">
        <label>
          Ребенок
          <select name="child_id" required>
            <option value="">Выберите ребенка</option>
            {% for child in assigned_children %}
              <option value="{{ child.id }}" {% if child.id == selected_request_child_id %}selected{% endif %}>{{ child.full_name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Навык ABLLS-R
          <select name="skill_code" required>
            <option value="">Выберите навык</option>
            {% for task in section_tasks %}
              <option value="{{ task.code }}" {% if task.code == selected_request_skill_code %}selected{% endif %}>{{ task.code }} - {{ task.objective }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Новый балл
          <select name="requested_score" required>
            {% for value in range(0, 5) %}
              <option value="{{ value }}">{{ value }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="checkbox-inline">
          <input type="checkbox" name="requested_is_prompted" value="true">
          <span>С подсказкой</span>
        </label>
        <label>
          Дата нового значения
          <input type="date" name="assessment_date" value="{{ today }}" required>
        </label>
        <label>
          Комментарий к изменению
          <input type="text" name="requested_comment" placeholder="Необязательно">
        </label>
        <label>
          Причина
          <textarea name="reason" rows="4" placeholder="Опишите, что нужно изменить" required></textarea>
        </label>
        <button type="submit">Отправить запрос</button>
      </form>
    </article>

    <article class="card">
      <h2>Статус запросов</h2>
      {% if my_edit_requests %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Ребенок</th>
                <th>Код</th>
                <th>Навык</th>
                <th>Запрошено</th>
                <th>Статус</th>
                <th>Комментарий админа</th>
              </tr>
            </thead>
            <tbody>
              {% for req in my_edit_requests %}
                {% set task = task_by_code.get(req.area) %}
                <tr>
                  <td>{{ req.created_at.strftime("%Y-%m-%d") }}</td>
                  <td>{{ my_edit_request_child_map.get(req.child_id).full_name if my_edit_request_child_map.get(req.child_id) else req.child_id }}</td>
                  <td>{{ req.area }}</td>
                  <td>{{ task.objective if task else "-" }}</td>
                  <td>
                    {% if req.requested_score is not none %}
                      {{ req.requested_score }}{% if task %} / {{ task.max_score }}{% endif %}
                      , {{ "с подсказкой" if req.requested_is_prompted else "самостоятельно" }}
                      {% if req.requested_assessment_date %}, {{ req.requested_assessment_date }}{% endif %}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge {{ 'approved' if req.status == 'approved' else ('pending' if req.status == 'pending' else 'in-progress') }}">
                      {{ req.status }}
                    </span>
                  </td>
                  <td>{{ req.admin_comment or "-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p>Запросов пока нет.</p>
      {% endif %}
    </article>
  </section>
{% endblock %}
